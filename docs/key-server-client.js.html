<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>key-server-client.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="KeyChain.html">KeyChain</a><ul class='methods'><li data-type='method'><a href="KeyChain.html#.getKeyByField">getKeyByField</a></li><li data-type='method'><a href="KeyChain.html#.getKeyBySubKeyId">getKeyBySubKeyId</a></li><li data-type='method'><a href="KeyChain.html#.getSubKeyIdByCapability">getSubKeyIdByCapability</a></li><li data-type='method'><a href="KeyChain.html#.isKeyFromCard">isKeyFromCard</a></li><li data-type='method'><a href="KeyChain.html#call">call</a></li><li data-type='method'><a href="KeyChain.html#cardStatus">cardStatus</a></li><li data-type='method'><a href="KeyChain.html#decrypt">decrypt</a></li><li data-type='method'><a href="KeyChain.html#encrypt">encrypt</a></li><li data-type='method'><a href="KeyChain.html#generateKey">generateKey</a></li><li data-type='method'><a href="KeyChain.html#hasCard">hasCard</a></li><li data-type='method'><a href="KeyChain.html#isCardTrusted">isCardTrusted</a></li><li data-type='method'><a href="KeyChain.html#listPublicKeys">listPublicKeys</a></li><li data-type='method'><a href="KeyChain.html#listSecretKeys">listSecretKeys</a></li><li data-type='method'><a href="KeyChain.html#lookupKey">lookupKey</a></li><li data-type='method'><a href="KeyChain.html#open">open</a></li><li data-type='method'><a href="KeyChain.html#recvKey">recvKey</a></li><li data-type='method'><a href="KeyChain.html#refreshKeys">refreshKeys</a></li><li data-type='method'><a href="KeyChain.html#sendKeys">sendKeys</a></li><li data-type='method'><a href="KeyChain.html#signKey">signKey</a></li><li data-type='method'><a href="KeyChain.html#tar">tar</a></li><li data-type='method'><a href="KeyChain.html#trustCard">trustCard</a></li><li data-type='method'><a href="KeyChain.html#trustKey">trustKey</a></li><li data-type='method'><a href="KeyChain.html#verify">verify</a></li><li data-type='method'><a href="KeyChain.html#whoami">whoami</a></li></ul></li><li><a href="KeyServerClient.html">KeyServerClient</a><ul class='methods'><li data-type='method'><a href="KeyServerClient.html#fetch">fetch</a></li><li data-type='method'><a href="KeyServerClient.html#search">search</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">key-server-client.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>



const Url = require('url').URL
const debug = require('debug')('gpg.KeyServerClient')
const request = require('request-promise')

const GPGParser = require('./gpg-parser')

/**
 * Schema for parsing search index from csv to json
 * @typedef {Object} HKPIndexSchema
 * @property {object} types
 * @property {object} types.info  info schame
 * @property {object} types.pub   pub schema
 * @property {object} types.uid   uid schema
 */
const HKPIndexSchema = {
  types: {
    info: {
      depth: 1,
      fields: {
        1: 'type',
        2: 'version',
        3: 'count'
      }
    },
    pub: {
      depth: 1,
      fields: {
        1: 'type',
        2: 'keyid',
        3: 'algo',
        4: 'keylen',
        5: 'creationdate',
        6: 'expirationdate',
        7: 'flags'
      }
    },
    uid: {
      depth: 2,
      fields: {
        1: 'type',
        2: 'user_id',
        3: 'creationdate',
        4: 'expirationdate',
        5: 'flags'
      }
    }
  }
}

class KeyServerClient {

  /**
   
  */

  /**
   * A client for PGP HKP Servers (Http Keyserver Protocol), see {@link https://tools.ietf.org/html/draft-shaw-openpgp-hkp-00|IETF spec} for protocol information.
   * @class
   * @constructor
   * @param {string} url Address of server, defaults to `KeyServerClient.Addresses.ubuntu`
   */
  constructor(url){
    /**
     * @type {Url}
     */
    this.baseUri = new Url( url || KeyServerClient.Addresses.ubuntu )
  }

  /**
   * Search for keys using text
   * @method
   * @param {string} text Search text
   * @returns {string} parsed colon-seperated-values into json
   */
  async search(text, exact=false){
    const searchUrl = new Url ('/pks/lookup', this.baseUri)

    searchUrl.searchParams.append('op', 'vindex')
    searchUrl.searchParams.append('options', 'mr')
    searchUrl.searchParams.append('search', text)
    //searchUrl.searchParams.append('fingerprint', 'on')


    debug('searching', searchUrl.toString())

    let index = {}
    
    const result = await request( searchUrl.toString() )
    
    debug('result', result)

  
    const parsed = GPGParser.parseColons(result, HKPIndexSchema)

    debug('parsed', parsed)

    return parsed
    
  }

  /**
   * @todo Not implemented
   * @method
   * @param {string} keyid 
   */
  async fetch(keyid){
    /** todo */
    throw new Error('not implemented')
  }

  /**
   * @type {Object}
   * @property {string} ubuntu https://keyserver.ubuntu.com
   * @property {string} gnupg http://keys.gnupg.net
   * @property {string} mit http://pgp.mit.edu
   */
  static get Addresses(){
    return {
      ubuntu: 'https://keyserver.ubuntu.com',
      gnupg: 'http://keys.gnupg.net',
      mit: 'http://pgp.mit.edu/'
    }
  }
}

module.exports = KeyServerClient</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Sun Dec 15 2019 18:51:39 GMT-0800 (Pacific Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
